<ion-header class="header">
  <ion-toolbar class="home-toolbar">
    <div class="header-row">
      <div class="left-group">
        <img src="assets/logo.PNG" alt="Tech Store" class="logo-large" />
        <ion-menu-button class="menu-btn" aria-label="Abrir menú" menu="categoriesMenu">
          <ion-icon name="menu-outline"></ion-icon>
        </ion-menu-button>
        <button class="link-inicio" (click)="goHome()" aria-label="Ir a Inicio">Inicio</button>
      </div>

      <div class="search-group">
        <div class="input-group">
          <span class="input-group-text bg-white border-end-0">
            <ion-icon name="search-outline"></ion-icon>
          </span>
          <input type="text" class="form-control border-start-0" placeholder="Buscar productos..."
            aria-label="Buscar productos" [(ngModel)]="searchTerm" [ngModelOptions]="{standalone: true}"
            (keyup)="onSearchChange($event)" />
          <button class="btn btn-outline-secondary" type="button" (click)="clearSearch()" aria-label="Limpiar búsqueda">
            <ion-icon name="close-outline"></ion-icon>
          </button>
        </div>
      </div>

      <div class="icons-group">
        <ion-button (click)="goToLogin()" fill="clear" aria-label="Iniciar sesión">
          <i class="bi bi-person-circle fs-4"></i>
        </ion-button>
        <ion-button (click)="goToCart()" fill="clear" class="position-relative" aria-label="Abrir carrito">
          <i class="bi bi-cart3 fs-4"></i>
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
            *ngIf="cartItemCount > 0">
            {{cartItemCount}}
            <span class="visually-hidden">productos en carrito</span>
          </span>
        </ion-button>
      </div>
    </div>

    <div class="filters-row">
      <div class="btn-group" role="group" aria-label="Filtros de productos">
        <button type="button" class="btn btn-outline-primary" [class.active]="selectedFilter === 'populares'"
          (click)="onFilterChange('populares')">
          <ion-icon name="flame-outline" class="me-1"></ion-icon>
          Populares
        </button>
        <button type="button" class="btn btn-outline-primary" [class.active]="selectedFilter === 'recientes'"
          (click)="onFilterChange('recientes')">
          <ion-icon name="time-outline" class="me-1"></ion-icon>
          Recientes
        </button>
      </div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content class="home-page">
  <!-- Pull to refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="refreshProducts($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Banner Slider -->
  <div class="banner-fullbleed" *ngIf="banners.length > 0">
    <div id="bannerCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel">
      <div class="carousel-indicators">
        <button *ngFor="let banner of banners; let i = index" type="button" [attr.data-bs-target]="'#bannerCarousel'"
          [attr.data-bs-slide-to]="i" [class.active]="i === 0" [attr.aria-label]="'Slide ' + (i + 1)">
        </button>
      </div>
      <div class="carousel-inner">
        <div class="carousel-item" *ngFor="let banner of banners; let i = index" [class.active]="i === 0"
          [attr.data-bs-interval]="(banner.video || banner.videoMp4 || banner.videoWebm) ? 0 : 3000">
          <ng-container *ngIf="banner.video || banner.videoMp4 || banner.videoWebm; else imageBanner">
            <video class="d-block banner-video" [attr.poster]="banner.poster || null" preload="auto" playsinline
              controls muted autoplay loop data-autoplay>
              <source *ngIf="banner.videoWebm" [src]="banner.videoWebm" type="video/webm" />
              <source *ngIf="banner.videoMp4 || banner.video" [src]="banner.videoMp4 || banner.video"
                type="video/mp4" />
              Tu navegador no soporta video HTML5.
            </video>
          </ng-container>
          <ng-template #imageBanner>
            <img [src]="banner.img" [attr.srcset]="banner.srcset || null" sizes="100vw" decoding="async"
              class="d-block banner-image" [alt]="banner.title || 'Banner'" (error)="banner.img = 'assets/logo.PNG'" />
          </ng-template>
          <div class="carousel-caption d-none d-md-block" *ngIf="banner.title || banner.description">
            <div class="banner-caption">
              <h3 class="banner-title"><i class="bi bi-stars me-2"></i>{{banner.title}}</h3>
              <p class="banner-subtitle">{{banner.description}}</p>
            </div>
          </div>
        </div>
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#bannerCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Anterior</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#bannerCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Siguiente</span>
      </button>
    </div>
  </div>

  <hr class="section-divider my-4" aria-hidden="true" />

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando productos...</p>
  </div>

  <!-- Productos -->
  <div *ngIf="!isLoading" class="container my-4 fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="fw-bold text-primary">
        <i class="bi bi-fire"></i> PRODUCTOS DISPONIBLES
      </h2>
      <span class="badge bg-secondary rounded-pill">{{ products.length }} productos</span>
    </div>

    <div class="row g-4">
      <div class="col-12 col-sm-6 col-md-4 col-lg-3" *ngFor="let product of products"
        (click)="viewProductDetails(product)" style="cursor: pointer;">

        <div class="card h-100 shadow-sm product-card-hover">
          <div class="position-relative">
            <!-- Prioridad: video directo silenciado > embed de Pinterest > imagen -->
            <ng-container *ngIf="product.video; else homeEmbed">
              <ng-container *ngIf="product.video && product.video.toLowerCase().endsWith('.gif'); else homeVideo">
                <img [src]="product.video" [alt]="product.name" class="card-img-top"
                  style="height: 200px; object-fit: cover;" />
              </ng-container>
              <ng-template #homeVideo>
                <video [src]="product.video" class="card-img-top" style="height: 200px; object-fit: cover;"
                  autoplay muted loop playsinline preload="metadata"></video>
              </ng-template>
            </ng-container>
            <ng-template #homeEmbed>
              <ng-container *ngIf="product.embedUrl; else homeImage">
                <div class="card-img-top media-wrapper">
                  <a data-pin-do="embedPin" data-pin-width="250" [href]="product.embedUrl"></a>
                </div>
              </ng-container>
              <ng-template #homeImage>
                <img [src]="product.image || 'assets/logo.PNG'" [alt]="product.name" class="card-img-top"
                  style="height: 200px; object-fit: cover;" (error)="product.image = 'assets/logo.PNG'" />
              </ng-template>
            </ng-template>

            <span *ngIf="product.featured"
              class="position-absolute top-0 start-0 translate-middle badge bg-warning text-dark">
              <i class="bi bi-star-fill"></i> Destacado
            </span>

            <span class="position-absolute top-0 end-0 badge" [class.bg-success]="product.stock > 0"
              [class.bg-danger]="product.stock === 0">
              <i class="bi" [class.bi-check-circle]="product.stock > 0" [class.bi-x-circle]="product.stock === 0"></i>
              {{ product.stock > 0 ? (product.stock + ' disponibles') : 'Agotado' }}
            </span>
          </div>

          <div class="card-body d-flex flex-column">
            <h5 class="card-title fw-bold text-truncate">{{ product.name }}</h5>
            <p class="card-text text-muted">
              <i class="bi bi-tag"></i> {{ product.category }}
            </p>

            <p class="card-text" *ngIf="product.description">
              <small>{{ product.description | slice:0:80 }}...</small>
            </p>

            <div class="mt-auto">
              <div class="d-flex justify-content-between align-items-center">
                <span class="h5 text-primary mb-0">{{ formatPrice(product.price) }}</span>
              </div>

              <div class="input-group input-group-sm mb-2">
                <span class="input-group-text">Cantidad</span>
                <input type="number" class="form-control" min="1" [max]="product.stock" [(ngModel)]="product.quantity"
                  [ngModelOptions]="{standalone: true}" (click)="$event.stopPropagation()" />
              </div>

              <button class="btn btn-primary btn-sm" (click)="addToCart(product); $event.stopPropagation()"
                type="submit" [disabled]="product.stock === 0">
                <i class="bi bi-cart-plus"></i> Agregar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sin productos -->
    <div *ngIf="products.length === 0" class="text-center py-5">
      <div class="card border-0 bg-light">
        <div class="card-body">
          <i class="bi bi-inbox display-1 text-muted"></i>
          <h3 class="mt-3">No hay productos disponibles</h3>
          <p class="text-muted">Los productos aparecerán aquí cuando sean agregados desde el panel de administración</p>
        </div>
      </div>
    </div>
  </div>
</ion-content>

<ion-footer class="footer bg-dark text-white">
  <div class="container py-4">
    <div class="row">
      <div class="col-md-6">
        <h5 class="fw-bold mb-3">
          <i class="bi bi-telephone-fill me-2"></i>Contáctanos
        </h5>
        <div class="d-flex gap-3">
          <a href="#" class="btn btn-outline-light btn-sm"><i class="bi bi-tiktok"></i></a>
          <a href="#" class="btn btn-outline-success btn-sm"><i class="bi bi-whatsapp"></i></a>
          <a href="#" class="btn btn-outline-danger btn-sm"><i class="bi bi-instagram"></i></a>
          <a href="#" class="btn btn-outline-danger btn-sm"><i class="bi bi-youtube"></i></a>
        </div>
      </div>
      <div class="col-md-6 text-md-end">
        <h5 class="fw-bold mb-3"><i class="bi bi-info-circle me-2"></i>Información</h5>
        <p><i class="bi bi-geo-alt me-2"></i>Dirección: Calle Principal #123</p>
        <p><i class="bi bi-telephone me-2"></i>Teléfono: +1 234-567-8900</p>
        <p><i class="bi bi-envelope me-2"></i>Email: info@techstore.com</p>
      </div>
    </div>
    <hr class="my-3">
    <div class="text-center">
      <p>&copy; 2024 TechStore. Todos los derechos reservados.</p>
    </div>
  </div>
</ion-footer>

<!-- Iconos de redes sociales -->
<app-social-icons></app-social-icons>